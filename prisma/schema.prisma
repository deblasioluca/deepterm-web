generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model ZKUser {
  id                         String             @id @default(cuid())
  email                      String             @unique
  masterPasswordHash         String
  protectedSymmetricKey      String
  publicKey                  String
  encryptedPrivateKey        String
  kdfType                    Int                @default(0)
  kdfIterations              Int                @default(600000)
  kdfMemory                  Int?
  kdfParallelism             Int?
  passwordHint               String?
  emailVerified              Boolean            @default(false)
  createdAt                  DateTime           @default(now())
  updatedAt                  DateTime           @updatedAt
  webUserId                  String?            @unique
  appleOriginalTransactionId String?            @unique
  applePurchaseDate          DateTime?
  appleExpiresDate           DateTime?
  appleProductId             String?
  devices                    Device[]
  organizationUsers          OrganizationUser[]
  refreshTokens              RefreshToken[]
  zkAuditLogs                ZKAuditLog[]
  webUser                    User?              @relation(fields: [webUserId], references: [id])
  zkVaults                   ZKVault[]
  zkVaultItems               ZKVaultItem[]

  @@index([email])
  @@index([webUserId])
}

model Device {
  id         String   @id @default(cuid())
  userId     String
  name       String
  deviceType String
  identifier String   @unique
  pushToken  String?
  lastActive DateTime @default(now())
  createdAt  DateTime @default(now())
  user       ZKUser   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model RefreshToken {
  id         String   @id @default(cuid())
  userId     String
  deviceId   String?
  tokenHash  String   @unique
  expiresAt  DateTime
  isRevoked  Boolean  @default(false)
  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now())
  user       ZKUser   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
}

model Organization {
  id           String             @id @default(cuid())
  name         String
  billingEmail String?
  plan         String             @default("free")
  maxMembers   Int                @default(5)
  maxVaults    Int                @default(10)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  members      OrganizationUser[]
  auditLogs    ZKAuditLog[]
  vaults       ZKVault[]
}

model OrganizationUser {
  id              String       @id @default(cuid())
  organizationId  String
  userId          String
  role            String       @default("member")
  encryptedOrgKey String?
  status          String       @default("invited")
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  user            ZKUser       @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model ZKVault {
  id             String        @id @default(cuid())
  userId         String?
  organizationId String?
  name           String
  isDefault      Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           ZKUser?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items          ZKVaultItem[]

  @@index([userId])
  @@index([organizationId])
}

model ZKVaultItem {
  id            String    @id @default(cuid())
  vaultId       String
  userId        String
  encryptedData String
  revisionDate  DateTime  @default(now())
  deletedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          ZKUser    @relation(fields: [userId], references: [id])
  vault         ZKVault   @relation(fields: [vaultId], references: [id], onDelete: Cascade)

  @@index([vaultId])
  @@index([userId])
  @@index([revisionDate])
  @@index([deletedAt])
}

model ZKAuditLog {
  id             String        @id @default(cuid())
  userId         String?
  organizationId String?
  eventType      String
  targetType     String?
  targetId       String?
  ipAddress      String?
  userAgent      String?
  deviceInfo     String?
  metadata       String?
  timestamp      DateTime      @default(now())
  organization   Organization? @relation(fields: [organizationId], references: [id])
  user           ZKUser?       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([organizationId])
  @@index([eventType])
  @@index([timestamp])
}

model RateLimitEntry {
  id           String    @id @default(cuid())
  key          String    @unique
  attempts     Int       @default(1)
  blockedUntil DateTime?
  windowStart  DateTime  @default(now())

  @@index([key])
}

model User {
  id                            String    @id @default(cuid())
  name                          String
  email                         String    @unique
  passwordHash                  String
  avatarUrl                     String?
  role                          String    @default("member")
  teamId                        String?
  twoFactorEnabled              Boolean   @default(false)
  twoFactorSecret               String?
  twoFactorBackupCodes          String?
  createdAt                     DateTime  @default(now())
  updatedAt                     DateTime  @updatedAt
  plan                          String    @default("free")
  stripeCustomerId              String?   @unique
  stripeSubscriptionId          String?
  appStoreOriginalTransactionId String?   @unique
  subscriptionSource            String    @default("none")
  subscriptionExpiresAt         DateTime?
  ideas                         Idea[]
  issues                        Issue[]
  passkeys                      Passkey[]
  sessions                      Session[]
  team                          Team?     @relation(fields: [teamId], references: [id])
  votes                         Vote[]
  zkUser                        ZKUser?
}

model Passkey {
  id           String    @id @default(cuid())
  userId       String
  credentialId String    @unique
  publicKey    String
  counter      Int       @default(0)
  deviceType   String?
  backedUp     Boolean   @default(false)
  transports   String?
  name         String    @default("Passkey")
  createdAt    DateTime  @default(now())
  lastUsedAt   DateTime?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Team {
  id                   String           @id @default(cuid())
  name                 String
  plan                 String           @default("starter")
  ssoEnabled           Boolean          @default(false)
  ssoDomain            String?
  ssoProvider          String?
  createdAt            DateTime         @default(now())
  stripeCustomerId     String?          @unique
  stripeSubscriptionId String?          @unique
  subscriptionStatus   String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean          @default(false)
  seats                Int              @default(1)
  invoices             Invoice[]
  paymentMethods       PaymentMethod[]
  invitations          TeamInvitation[]
  members              User[]
}

model Invoice {
  id               String   @id @default(cuid())
  teamId           String
  stripeInvoiceId  String   @unique
  amountPaid       Int
  amountDue        Int
  currency         String   @default("usd")
  status           String
  invoicePdf       String?
  hostedInvoiceUrl String?
  periodStart      DateTime
  periodEnd        DateTime
  createdAt        DateTime @default(now())
  team             Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
}

model PaymentMethod {
  id                    String   @id @default(cuid())
  teamId                String
  stripePaymentMethodId String   @unique
  type                  String
  brand                 String?
  last4                 String?
  expMonth              Int?
  expYear               Int?
  email                 String?
  walletType            String?
  fingerprint           String?
  country               String?
  funding               String?
  isDefault             Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  team                  Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
}

model AdminUser {
  id                   String         @id @default(cuid())
  email                String         @unique
  passwordHash         String
  name                 String
  role                 String         @default("admin")
  isActive             Boolean        @default(true)
  lastLoginAt          DateTime?
  twoFactorEnabled     Boolean        @default(false)
  twoFactorSecret      String?
  twoFactorBackupCodes String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  passkeys             AdminPasskey[]
  auditLogs            AuditLog[]
}

model AdminPasskey {
  id           String    @id @default(cuid())
  adminUserId  String
  credentialId String    @unique
  publicKey    String
  counter      Int       @default(0)
  deviceType   String?
  backedUp     Boolean   @default(false)
  transports   String?
  name         String    @default("Passkey")
  createdAt    DateTime  @default(now())
  lastUsedAt   DateTime?
  admin        AdminUser @relation(fields: [adminUserId], references: [id], onDelete: Cascade)

  @@index([adminUserId])
}

model Release {
  id               String   @id @default(cuid())
  platform         String
  version          String
  releaseNotes     String
  sha256           String?
  minimumOSVersion String   @default("14.0")
  mandatory        Boolean  @default(false)
  fileFilename     String
  filePath         String
  sizeBytes        Int?
  publishedAt      DateTime @default(now())
  createdBy        String?

  @@unique([platform, version])
  @@index([platform, publishedAt])
}

model SubscriptionOffering {
  id              String   @id @default(cuid())
  key             String
  interval        String
  stage           String
  name            String
  description     String?
  priceCents      Int
  currency        String   @default("usd")
  isActive        Boolean  @default(true)
  stripeProductId String?
  stripePriceId   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([key, interval, stage])
  @@index([stage])
}

model AuditLog {
  id         String    @id @default(cuid())
  adminId    String
  action     String
  entityType String
  entityId   String
  metadata   String?
  ipAddress  String?
  createdAt  DateTime  @default(now())
  admin      AdminUser @relation(fields: [adminId], references: [id])

  @@index([entityType, entityId])
  @@index([adminId])
}

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

model SecurityAlert {
  id         String    @id @default(cuid())
  eventType  String
  severity   String    @default("medium")
  sourceIp   String
  path       String?
  userAgent  String?
  details    String?
  resolved   Boolean   @default(false)
  resolvedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([eventType, createdAt])
  @@index([sourceIp, createdAt])
  @@index([resolved, createdAt])
}

model Idea {
  id          String   @id @default(cuid())
  title       String
  description String
  category    String   @default("feature")
  status      String   @default("consideration")
  authorId    String
  createdAt   DateTime @default(now())
  author      User     @relation(fields: [authorId], references: [id])
  votes       Vote[]
}

model Vote {
  id     String @id @default(cuid())
  userId String
  ideaId String
  idea   Idea   @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])

  @@unique([userId, ideaId])
}

model Session {
  id         String   @id @default(cuid())
  userId     String
  device     String
  ipAddress  String
  lastActive DateTime @default(now())
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Announcement {
  id        String    @id @default(cuid())
  title     String
  content   String
  type      String    @default("info")
  isActive  Boolean   @default(true)
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model TeamInvitation {
  id          String   @id @default(cuid())
  email       String
  teamId      String
  role        String   @default("member")
  token       String   @unique
  invitedById String
  status      String   @default("pending")
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([teamId])
}

model Issue {
  id                 String            @id @default(cuid())
  userId             String
  title              String
  description        String
  area               String            @default("General")
  status             String            @default("open")
  reporterFeedback   String?
  reporterFeedbackAt DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  attachments        IssueAttachment[]
  updates            IssueUpdate[]

  @@index([userId, createdAt])
  @@index([status, updatedAt])
  @@index([area, updatedAt])
}

model IssueAttachment {
  id               String   @id @default(cuid())
  issueId          String
  kind             String
  originalFilename String
  mimeType         String
  sizeBytes        Int
  storagePath      String
  createdAt        DateTime @default(now())
  issue            Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId])
}

model IssueUpdate {
  id          String   @id @default(cuid())
  issueId     String
  authorType  String
  authorEmail String?
  message     String
  status      String?
  createdAt   DateTime @default(now())
  issue       Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId, createdAt])
}

model CiBuild {
  id            String   @id @default(cuid())
  runId         String   @unique
  repo          String
  branch        String
  workflow      String
  conclusion    String
  commitMessage String   @default("")
  duration      String?
  url           String   @default("")
  triggeredAt   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([repo, branch, createdAt])
  @@index([conclusion, createdAt])
}

model GithubEvent {
  id        String   @id @default(cuid())
  eventType String
  repo      String
  branch    String   @default("")
  actor     String
  summary   String   @default("")
  url       String   @default("")
  createdAt DateTime @default(now())

  @@index([repo, createdAt])
  @@index([eventType, createdAt])
}

model GithubIssue {
  id              String   @id @default(cuid())
  number          Int      @unique
  title           String
  body            String   @default("")
  state           String   @default("open")
  labels          String   @default("[]")
  milestone       String?
  assignee        String?
  url             String   @default("")
  githubCreatedAt DateTime
  githubUpdatedAt DateTime
  syncedAt        DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([state, githubUpdatedAt])
  @@index([number])
}

model PaymentEvent {
  id        String   @id @default(cuid())
  email     String
  event     String
  plan      String
  amount    Int?
  details   String?
  createdAt DateTime @default(now())

  @@index([email, createdAt])
  @@index([event, createdAt])
}

model Epic {
  id                   String                @id @default(cuid())
  title                String
  description          String                @default("")
  status               String                @default("backlog")
  priority             String                @default("medium")
  sortOrder            Int                   @default(0)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  deliberations        Deliberation[]
  implementationReport ImplementationReport?
  stories              Story[]

  @@index([status])
  @@index([sortOrder])
}

model Story {
  id                   String                @id @default(cuid())
  epicId               String?
  title                String
  description          String                @default("")
  status               String                @default("backlog")
  priority             String                @default("medium")
  githubIssueNumber    Int?
  sortOrder            Int                   @default(0)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  agentLoops           AgentLoop[]
  deliberations        Deliberation[]
  implementationReport ImplementationReport?
  epic                 Epic?                 @relation(fields: [epicId], references: [id])

  @@index([epicId])
  @@index([status])
  @@index([sortOrder])
}

/// A deliberation session attached to a Story or Epic.
/// Tracks the full lifecycle: proposals → debate → vote → decision.
model Deliberation {
  id                String                 @id @default(cuid())
  type              String
  status            String                 @default("proposing")
  storyId           String?
  epicId            String?
  title             String                 @default("")
  instructions      String                 @default("")
  summary           String                 @default("")
  managementSummary String                 @default("")
  error             String?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  epic              Epic?                  @relation(fields: [epicId], references: [id])
  story             Story?                 @relation(fields: [storyId], references: [id])
  debates           DeliberationDebate[]
  proposals         DeliberationProposal[]
  votes             DeliberationVote[]

  @@index([storyId])
  @@index([epicId])
  @@index([type, status])
}

/// One agent's proposal within a deliberation.
model DeliberationProposal {
  id             String       @id @default(cuid())
  deliberationId String
  agentName      String
  agentModel     String
  content        String
  strengths      String       @default("")
  risks          String       @default("")
  effort         String       @default("")
  createdAt      DateTime     @default(now())
  deliberation   Deliberation @relation(fields: [deliberationId], references: [id], onDelete: Cascade)

  @@index([deliberationId])
}

/// A debate round — one agent responds to others' proposals.
model DeliberationDebate {
  id                    String       @id @default(cuid())
  deliberationId        String
  round                 Int
  agentName             String
  agentModel            String
  content               String
  referencesProposalIds String       @default("")
  createdAt             DateTime     @default(now())
  deliberation          Deliberation @relation(fields: [deliberationId], references: [id], onDelete: Cascade)

  @@index([deliberationId, round])
}

/// Agent votes after debate concludes.
model DeliberationVote {
  id              String       @id @default(cuid())
  deliberationId  String
  agentName       String
  agentModel      String
  votedFor        String
  reasoning       String
  createdAt       DateTime     @default(now())
  votedProposalId String?
  deliberation    Deliberation @relation(fields: [deliberationId], references: [id], onDelete: Cascade)

  @@index([deliberationId])
}

/// Implementation report attached to a Story/Epic.
model ImplementationReport {
  id               String   @id @default(cuid())
  storyId          String?  @unique
  epicId           String?  @unique
  status           String   @default("pending")
  testsAdded       String   @default("[]")
  testsUpdated     String   @default("[]")
  docsUpdated      String   @default("[]")
  helpPagesUpdated String   @default("[]")
  filesChanged     String   @default("[]")
  prNumbers        String   @default("[]")
  summary          String   @default("")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  epic             Epic?    @relation(fields: [epicId], references: [id])
  story            Story?   @relation(fields: [storyId], references: [id])

  @@index([storyId])
  @@index([epicId])
}

/// AI/LLM provider configuration — API keys stored encrypted.
model AIProvider {
  id            String    @id @default(cuid())
  name          String
  slug          String    @unique
  encryptedKey  String    @default("")
  baseUrl       String?
  isEnabled     Boolean   @default(true)
  isValid       Boolean   @default(false)
  lastValidated DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  models        AIModel[]

  @@index([slug])
  @@index([isEnabled])
}

/// Available model for a provider.
model AIModel {
  id              String                 @id @default(cuid())
  providerId      String
  modelId         String
  displayName     String
  capabilities    String                 @default("[]")
  contextWindow   Int                    @default(128000)
  costPer1kInput  Float                  @default(0)
  costPer1kOutput Float                  @default(0)
  isEnabled       Boolean                @default(true)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  assignments          AIActivityAssignment[] @relation("primaryAssignment")
  secondaryAssignments AIActivityAssignment[] @relation("secondaryAssignment")
  tertiaryAssignments  AIActivityAssignment[] @relation("tertiaryAssignment")
  provider        AIProvider             @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, modelId])
  @@index([providerId])
  @@index([isEnabled])
}

/// Maps an AI activity to a specific model.
model AIActivityAssignment {
  id                   String   @id @default(cuid())
  activity             String   @unique
  modelId              String
  temperature          Float    @default(0.7)
  maxTokens            Int      @default(4096)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  systemPromptOverride String?
  secondaryModelId     String?
  tertiaryModelId      String?
  model                AIModel  @relation("primaryAssignment", fields: [modelId], references: [id], onDelete: Cascade)
  secondaryModel       AIModel? @relation("secondaryAssignment", fields: [secondaryModelId], references: [id], onDelete: SetNull)
  tertiaryModel        AIModel? @relation("tertiaryAssignment", fields: [tertiaryModelId], references: [id], onDelete: SetNull)

  @@index([activity])
  @@index([modelId])
}

/// Every AI API call is logged here.
model AIUsageLog {
  id             String   @id @default(cuid())
  provider       String
  model          String
  activity       String
  category       String
  inputTokens    Int      @default(0)
  outputTokens   Int      @default(0)
  totalTokens    Int      @default(0)
  costCents      Float    @default(0)
  deliberationId String?
  agentLoopId    String?
  storyId        String?
  epicId         String?
  durationMs     Int      @default(0)
  success        Boolean  @default(true)
  errorMessage   String?
  createdAt      DateTime @default(now())

  @@index([provider])
  @@index([activity])
  @@index([category])
  @@index([createdAt])
  @@index([deliberationId])
  @@index([agentLoopId])
  @@index([storyId])
  @@index([epicId])
}

/// Daily/monthly aggregates for fast dashboard queries.
model AIUsageAggregate {
  id            String @id @default(cuid())
  period        String
  periodType    String
  provider      String
  model         String
  activity      String
  category      String
  callCount     Int    @default(0)
  inputTokens   Int    @default(0)
  outputTokens  Int    @default(0)
  totalTokens   Int    @default(0)
  costCents     Float  @default(0)
  avgDurationMs Int    @default(0)
  errorCount    Int    @default(0)

  @@unique([period, periodType, provider, model, activity])
  @@index([period])
  @@index([periodType])
  @@index([provider])
  @@index([category])
}

/// Reusable agent loop configurations (e.g., 'default', 'careful', 'fast').
model AgentLoopConfig {
  id             String      @id @default(cuid())
  name           String      @unique
  description    String      @default("")
  provider       String      @default("anthropic")
  model          String      @default("claude-sonnet-4-20250514")
  maxIterations  Int         @default(10)
  targetRepo     String      @default("deblasioluca/deepterm")
  targetBranch   String      @default("main")
  allowedPaths   String      @default("[]")
  forbiddenPaths String      @default("[]")
  systemPrompt   String      @default("")
  autoCreatePR   Boolean     @default(true)
  requireTests   Boolean     @default(true)
  requireBuild   Boolean     @default(true)
  isEnabled      Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  loops          AgentLoop[]
}

/// A single agent loop execution — tied to a Story + optional Deliberation.
model AgentLoop {
  id              String           @id @default(cuid())
  configId        String?
  storyId         String?
  deliberationId  String?
  status          String           @default("queued")
  branchName      String           @default("")
  prNumber        Int?
  prUrl           String?
  totalIterations Int              @default(0)
  maxIterations   Int              @default(10)
  inputTokens     Int              @default(0)
  outputTokens    Int              @default(0)
  costCents       Float            @default(0)
  errorLog        String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  iterations      AgentIteration[]
  story           Story?           @relation(fields: [storyId], references: [id])
  config          AgentLoopConfig? @relation(fields: [configId], references: [id])

  @@index([storyId])
  @@index([configId])
  @@index([deliberationId])
  @@index([status])
  @@index([createdAt])
}

/// One iteration within an agent loop (think → act → observe).
model AgentIteration {
  id           String    @id @default(cuid())
  loopId       String
  iteration    Int
  phase        String    @default("thinking")
  thinking     String    @default("")
  action       String    @default("")
  observation  String    @default("")
  filesChanged String    @default("[]")
  inputTokens  Int       @default(0)
  outputTokens Int       @default(0)
  costCents    Float     @default(0)
  durationMs   Int       @default(0)
  createdAt    DateTime  @default(now())
  loop         AgentLoop @relation(fields: [loopId], references: [id], onDelete: Cascade)

  @@index([loopId, iteration])
}
